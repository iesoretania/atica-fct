{% trans_default_domain 'group' %}
{% extends 'layout.html.twig' %}
{% import '::macros.html.twig' as m %}

{% block content %}
    {{ form_start(form) }}
        {{ form_widget(form) }}
        {{ m.start_button }}
        {{ m.submit_button('submit', 'check', 'btn-success', 'form.submit'|trans) }}
        {{ m.end_button }}
    {{ form_end(form) }}
    {{ m.link_button(path('admin_group_student_agreements', {'id': agreement.student.id}), 'arrow-left', 'btn-default', 'form.back'|trans) }}
    {% if agreement.id != 0 %}
        <p></p>
        <div class="alert alert-warning">{{ 'prompt.activity_deletion_warning'|trans|nl2br }}</div>
    {% endif %}

    <div class="modal fade" id="new_user" role="dialog" aria-labelledby="new_role-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="new_role-label">{{ 'form.new_user'|trans }}</h4>
                </div>
                <div class="modal-body">
                    {{ render(controller('AppBundle:Group:apiNewUser')) }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{{ 'form.new_user.close'|trans }}</button>
                    <button type="button" class="btn btn-success" id="create_user">{{ 'form.new_user.save'|trans }}</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

{% endblock %}

{% block javascripts %}
<script>
    var student = $("#agreement_student");
    var company = $("#agreement_company");

    student.change(function() {
        var form = $(this).closest('form');
        var data = {};
        data[student.attr('name')] = student.val();
        data[company.attr('name')] = company.val();
        $('#agreement_activities').replaceWith('<div id="agreement_activities"><span class="text-info"><i class="fa fa-refresh fa-spin fa-3x fa-fw"></i></span></div>');
        $.ajax({
            url: form.attr('action'),
            type: form.attr('method'),
            data: data,
            success: function(html) {
                $('#agreement_activities').replaceWith(
                        $(html).find('#agreement_activities')
                )
            },
            error: function() {
                $('#agreement_activities').replaceWith('<div id="agreement_activities"><span class="text-danger"><i class="fa fa-times-circle fa-3x"></i></span></div>')
            }
        });
    });

    company.change(function() {
        var form = $(this).closest('form');
        var data = {};
        data[student.attr('name')] = student.val();
        data[company.attr('name')] = company.val();
        var workcenter = $('#agreement_workcenter');
        var next = workcenter.next();
        workcenter.replaceWith('<div id="agreement_workcenter"><span class="text-info"><i class="fa fa-refresh fa-spin fa-3x fa-fw"></i></span></div>');
        next.remove();
        $.ajax({
            url: form.attr('action'),
            type: form.attr('method'),
            data: data,
            success: function(html) {
                $('#agreement_workcenter').replaceWith(
                        $(html).find('#agreement_workcenter')
                );
                $('select#agreement_workcenter').select2({
                    theme: "bootstrap"
                });
            },
            error: function() {
                $('#agreement_workcenter').replaceWith('<div id="agreement_workcenter"><span class="text-danger"><i class="fa fa-times-circle fa-3x"></i></span></div>')
            }
        });
    });

    function sendForm(form, callback) {
        var values = {};
        $.each(form[0].elements, function(i, field) {
            values[field.name] = field.value;
        });

        $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            data: values,
            success: function(result) { callback(result); }
        });
    }

    function clearForm(form) {
        var values = {};
        $.each(form[0].elements, function(i, field) {
            field.value = "";
        });

        $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            data: values,
            success: function(result) { callback(result); }
        });
    }

    my_item = $("select#agreement_workTutor");

    $(function() {
        $("select.person").select2('destroy');
        $("select.person")
                .append($('<option>', {value: 'new', text: "{{ 'form.new_user'|trans|e('js') }}"}))
                .select2({
                    theme: "bootstrap"
                })
                .on('change', function(e) {
                    my_item = e.currentTarget;
                    if (e.currentTarget.value === 'new') {
                        $('#new_user').modal('show');
                    }
                });
    });

    $('#create_user').on('click', function (e) {
        e.preventDefault();
        sendForm($('.modal-body').find('form'), function(response) {
            if (typeof response == "object") {
                $("select.person").select2('destroy');
                $("select.person")
                    .prepend($('<option>', {value: response.id, text: response.name}));
                $("select.person").select2({
                    theme: "bootstrap"
                });

                $('#new_user').modal('hide');

                clearForm($('.modal-body').find('form'));

                $(my_item).select2({
                    theme: "bootstrap"
                }).val(response.id);

                $(my_item).select2({
                    theme: "bootstrap"
                }).val(response.id);
            }
            else {
                $('#new_user').find('.modal-body').html(response);
            }
        });
    });
</script>
{% endblock %}
